<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Shoe Try-On</title>

    <!-- 
      NEW "BULLETPROOF" LOADING METHOD:
      We now load all libraries directly in the <head>.
      This is much more reliable than the importmap.
    -->
    
    <!-- 1. Load MediaPipe -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm/vision_bundle.js"></script>
    
    <!-- 2. Load Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <!-- 3. Load the 3D Model Loader (GLTFLoader) -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>


    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
        }
        #webcam {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        #three_canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1);
        }
        #output_canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            transform: scaleX(-1);
            display: none; /* Hide the 2D dots */
        }
        #loading_message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: sans-serif;
            font-size: 1.2rem;
            text-align: center;
            width: 90%;
        }
    </style>
</head>

<body>
    <video id="webcam" autoplay playsinline muted></video>
    <canvas id="three_canvas"></canvas>
    <canvas id="output_canvas"></canvas>
    <div id="loading_message">
        <p id="loading_text">Loading AR Model...</p>
    </div>

    <!-- 
      UPDATED SCRIPT:
      - This is NO LONGER a "type=module". It's a regular script.
      - It will wait for all the libraries in the <head> to load.
      - All 'import' statements are GONE.
      - We now access the libraries via global variables like
        'THREE' and 'mediapipe'.
    -->
    <script>
        // Wait for the whole page (including scripts) to load
        window.addEventListener("load", () => {
            console.log("Page loaded, starting AR app...");
            startApp();
        });

        function startApp() {
            // --- Get HTML Elements ---
            const videoElement = document.getElementById('webcam');
            const canvasElement = document.getElementById("output_canvas");
            const canvasCtx = canvasElement.getContext("2d");
            const loadingMessage = document.getElementById("loading_message");
            const threeCanvas = document.getElementById("three_canvas");
            const loadingText = document.getElementById("loading_text");

            // --- Define global-scope variables ---
            let poseLandmarker;
            let runningMode = "VIDEO";
            let webcamRunning = false;
            let drawingUtils;
            let lastVideoTime = -1;
            let scene, camera, renderer, shoeModel;
            const clock = new THREE.Clock(); // From THREE global

            // --- Access libraries from global scope ---
            // These were loaded in the <head>
            const { PoseLandmarker, FilesetResolver } = mediapipe.tasks.vision;
            const { DrawingUtils } = mediapipe.drawing;
            
            // Check if libraries loaded
            if (!PoseLandmarker || !THREE || !THREE.GLTFLoader) {
                console.error("Critical libraries failed to load!");
                loadingText.innerHTML = `<p style="color: red;">Error: Core libraries failed to load. Please check your internet connection and reload.</p>`;
                return;
            }

            // --- Foot Landmark IDs ---
            const LANDMARK_IDS = {
                LEFT_HEEL: 29,
                LEFT_FOOT_INDEX: 31,
                RIGHT_HEEL: 30,
                RIGHT_FOOT_INDEX: 32
            };

            // ======================================================
            //  FUNCTIONS
            // ======================================================

            function setupThreeJS() {
                console.log("Setting up 3D scene...");
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.z = 5;

                renderer = new THREE.WebGLRenderer({
                    canvas: threeCanvas,
                    alpha: true
                });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(window.devicePixelRatio);

                const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
                scene.add(ambientLight);
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(0, 1, 2);
                scene.add(directionalLight);

                loadShoeModel();
            }

            function loadShoeModel() {
                console.log("Loading shoe model...");
                loadingText.innerHTML = "Loading 3D Shoe Model...";
                
                // Use THREE.GLTFLoader (from the global THREE object)
                const loader = new THREE.GLTFLoader(); 
                const shoeURL = "shoe.glb"; // Make sure this file is uploaded!

                loader.load(
                    shoeURL,
                    function (gltf) {
                        console.log("Shoe model loaded successfully!");
                        loadingText.innerHTML = "3D Model Loaded.";
                        shoeModel = gltf.scene;
                        shoeModel.visible = false;
                        shoeModel.scale.set(0.01, 0.01, 0.01);
                        scene.add(shoeModel);
                    },
                    undefined,
                    function (error) {
                        console.error("Error loading shoe model: ", error);
                        loadingMessage.style.display = "block";
                        loadingText.innerHTML = `<p style="color: red;">Error: Could not load 'shoe.glb'.<br/>Please make sure the file is uploaded to GitHub and the name is correct.</p>`;
                    }
                );
            }

            function animate3D() {
                requestAnimationFrame(animate3D);
                if(renderer && scene && camera) {
                    renderer.render(scene, camera);
                }
            }

            async function createPoseLandmarker() {
                console.log("Creating Pose Landmarker...");
                loadingText.innerHTML = "Loading ML Model Files...";
                try {
                    drawingUtils = new DrawingUtils(canvasCtx);
                    const vision = await FilesetResolver.forVisionTasks(
                        "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm"
                    );
                    
                    loadingText.innerHTML = "Initializing ML Model... (This may take a moment)";
                    
                    poseLandmarker = await PoseLandmarker.createFromOptions(vision, {
                        baseOptions: {
                            modelAssetPath: `https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_lite/float16/pose_landmarker_lite.task`,
                            delegate: "CPU" // Use "CPU" for max compatibility
                        },
                        runningMode: runningMode,
                        numPoses: 1
                    });
                    console.log("Pose Landmarker model loaded.");
                    loadingText.innerHTML = "ML Model Loaded.";

                } catch(err) {
                    console.error("Error creating Pose Landmarker: ", err);
                    loadingText.innerHTML = `<p style="color: red;">Error loading ML Model.<br/>${err.message}.<br/>Please reload the page.</p>`;
                    throw err; // Stop the app
                }
            }

            async function startCamera() {
                try {
                    if (!poseLandmarker) {
                        console.log("Waiting for PoseLandmarker...");
                        loadingText.innerHTML = "Waiting for ML Model...";
                        await createPoseLandmarker();
                    }

                    setupThreeJS(); 
                    animate3D(); // Start 3D render loop

                    loadingText.innerHTML = "Requesting Camera Access...";
                    
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "user" }
                    });
                    videoElement.srcObject = stream;

                    videoElement.addEventListener("loadeddata", () => {
                        loadingMessage.style.display = "none";
                        webcamRunning = true;
                        predictWebcam();
                    });
                } catch (err) {
                    console.error("Error starting camera or loading model: ", err);
                    loadingMessage.style.display = "block";
                    if (!loadingText.innerHTML.includes("Error")) {
                         loadingText.innerHTML = `<p style="color: red;">Error: Could not start.<br/>${err.message}</p>`;
                    }
                }
            }

            async function predictWebcam() {
                if (!videoElement.videoWidth) {
                    requestAnimationFrame(predictWebcam); // Wait for video to be ready
                    return;
                }

                if (canvasElement.width !== videoElement.videoWidth) {
                    console.log("Resizing canvas to video dimensions");
                    canvasElement.width = videoElement.videoWidth;
                    canvasElement.height = videoElement.videoHeight;
                    renderer.setSize(videoElement.videoWidth, videoElement.videoHeight);
                    camera.aspect = videoElement.videoWidth / videoElement.videoHeight;
                    camera.updateProjectionMatrix();
                }

                const startTimeMs = performance.now();
                if (videoElement.currentTime !== lastVideoTime) {
                    lastVideoTime = videoElement.currentTime;
                    
                    poseLandmarker.detectForVideo(videoElement, startTimeMs, (result) => {
                        if (shoeModel && result.landmarks && result.landmarks.length > 0) {
                            const landmarks = result.landmarks[0];
                            const heel = landmarks[LANDMARK_IDS.LEFT_HEEL];
                            const toes = landmarks[LANDMARK_IDS.LEFT_FOOT_INDEX];

                            if (heel.visibility > 0.5 && toes.visibility > 0.5) {
                                shoeModel.visible = true;

                                const footMidX = (heel.x + toes.x) / 2;
                                const footMidY = (heel.y + toes.y) / 2;
                                
                                const footPos = new THREE.Vector3();
                                footPos.set(
                                    (footMidX * 2) - 1,
                                    -(footMidY * 2) + 1,
                                    0.9 
                                );
                                
                                footPos.unproject(camera);
                                shoeModel.position.copy(footPos);

                                const angle = Math.atan2(
                                    (toes.y - heel.y) * videoElement.videoHeight,
                                    (toes.x - heel.x) * videoElement.videoWidth
                                );
                                
                                shoeModel.rotation.set(0, 0, angle - Math.PI / 2);

                                const dx = (toes.x - heel.x) * videoElement.videoWidth;
                                const dy = (toes.y - heel.y) * videoElement.videoHeight;
                                const dist = Math.sqrt(dx*dx + dy*dy);
                                
                                const scale = dist * 0.0015;
                                shoeModel.scale.set(scale, scale, scale);

                            } else {
                                shoeModel.visible = false;
                            }
                        } else {
                            if (shoeModel) {
                                shoeModel.visible = false;
                            }
                        }
                        
                        // Draw 2D landmarks (on hidden canvas)
                        canvasCtx.save();
                        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
                        if (result.landmarks && result.landmarks.length > 0) {
                            for (const landmark of result.landmarks) {
                                drawingUtils.drawLandmarks(landmark, {
                                    radius: (data) => DrawingUtils.lerp(data.from.z, -0.15, 0.1, 5, 1)
                                });
                                drawingUtils.drawConnectors(landmark, PoseLandmarker.POSE_CONNECTIONS);
                            }
                        }
                        canvasCtx.restore();
                    });
                }

                if (webcamRunning) {
                    window.requestAnimationFrame(predictWebcam);
                }
            }

            // ======================================================
            //  START THE APP
            // ======================================================
            startCamera();
        }
    </script>
</body>
</html>


